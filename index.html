<html>

<head>
    <meta charset="UTF-8">
    <!-- Third party dependencies -->
    <link rel="stylesheet" href="libs/material-components-web-10.0.0.min.css">
    <link rel="stylesheet" href="libs/material-icons.css">
    <script src="libs/material-components-web-10.0.0.min.js"></script>

    <!-- Our own resources-->
    <link rel="stylesheet" href="src/css/theme.css">
    <script src="src/js/Note.js"></script>
    <script src="src/js/Scale.js"></script>
    <script src="src/js/i18n/I18n.js"></script>
    <script src="src/js/i18n/strings_en.js"></script>
    <script src="src/js/model/ScaleGenerator.js"></script>
    <script src="src/js/model/ScalePlayer.js"></script>
    <script src="src/js/model/Settings.js"></script>
    <script src="src/js/model/SettingsAccess.js"></script>
    <script src="src/js/model/SpeechEngine.js"></script>
    <script src="src/js/view/CountdownTimer.js"></script>
    <script src="src/js/viewmodel/NoteName.js"></script>
    <script src="src/js/viewmodel/ScaleName.js"></script>
    <script>
        async function playAllScales(startingNote) {
            const elemScaleId = document.querySelector("#scale-id")
            const elemScaleImg = document.querySelector("#scale-img")
            const scales = scaleGenerator.createScales(startingNote)
            console.log(scales)
            const tempoBpm = settings.getTempoBpm()
            const preparationTimeS = settings.getPreparationTimeS()
            const countdownTimer = new CountdownTimer(document.querySelector("#countdown-timer"))
            for (const scale of scales) {
                const currentlyPlayingText = `${noteName.getNoteName(scale.startingNote)} ${scaleName.getScaleName(scale)}`
                const currentlyPlayingTextTts = `${noteName.getTtsNoteName(scale.startingNote)} ${scaleName.getScaleName(scale)}`
                const scaleImgName = scaleName.getScaleImage(scale)
                console.log(scaleImgName)
                elemScaleId.innerText = currentlyPlayingText
                elemScaleImg.src = scaleImgName
                speechEngine.playText(currentlyPlayingTextTts)
                countdownTimer.start(settings.getPreparationTimeS())
                await scalePlayer.playScale(scale, preparationTimeS, tempoBpm)
            }
        }
        const i18n = new I18n()
        const scalePlayer = new ScalePlayer()
        const settings = new Settings(new SettingsAccess())
        const scaleGenerator = new ScaleGenerator(settings)
        const noteName = new NoteName(settings, i18n)
        const scaleName = new ScaleName(i18n)
        const speechEngine = new SpeechEngine()
        function doit() {
            if (scalePlayer.isPlaying()) {
                scalePlayer.stop()
            } else {
                const startingNote = Note.Notes[document.querySelector("#notes").value]
                playAllScales(startingNote).then(() => scalePlayer.stop())
            }
        }
        function app_init() {
            i18n.translateElement(document.documentElement)
        }
    </script>
</head>

<body onload="app_init()">
    <select name="notes" id="notes">
        <option value="C4" string-key="C_abc"></option>
        <option value="CS4" string-key="CS_abc"></option>
        <option value="D4" string-key="D_abc"></option>
        <option value="DS4" string-key="DS_abc"></option>
        <option value="E4" string-key="E_abc"></option>
        <option value="F4" string-key="F_abc"></option>
        <option value="FS4" string-key="FS_abc"></option>
        <option value="G4" string-key="G_abc"></option>
        <option value="GS4" string-key="GS_abc"></option>
        <option value="A4" string-key="A_abc"></option>
        <option value="AS4" string-key="AS_abc"></option>
        <option value="B4" string-key="B_abc"></option>
        <option value="C5" string-key="C_abc"></option>
    </select>

    <div id="scale-id"></div>
    <img id="scale-img">
    <div id="countdown-timer"></div>

    <button onclick="doit()">Click me</button>
</body>

</html>