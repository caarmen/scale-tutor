<html>

<head>
    <meta charset="UTF-8">
    <!-- Third party dependencies -->
    <link rel="stylesheet" href="libs/material-components-web-10.0.0.min.css">
    <link rel="stylesheet" href="libs/material-icons.css">
    <script src="libs/material-components-web-10.0.0.min.js"></script>

    <!-- Our own resources-->
    <link rel="stylesheet" href="src/css/theme.css">
    <script src="src/js/Note.js"></script>
    <script src="src/js/Scale.js"></script>
    <script src="src/js/i18n/I18n.js"></script>
    <script src="src/js/i18n/strings_en.js"></script>
    <script src="src/js/model/ScaleGenerator.js"></script>
    <script src="src/js/model/ScalePlayer.js"></script>
    <script src="src/js/model/Settings.js"></script>
    <script src="src/js/model/SettingsAccess.js"></script>
    <script src="src/js/model/SpeechEngine.js"></script>
    <script src="src/js/view/CountdownTimer.js"></script>
    <script src="src/js/view/ControlsView.js"></script>
    <script src="src/js/view/ScaleView.js"></script>
    <script src="src/js/viewmodel/NoteName.js"></script>
    <script src="src/js/viewmodel/ScaleName.js"></script>
    <script>
        // model
        const scalePlayer = new ScalePlayer()
        const settings = new Settings(new SettingsAccess())
        const scaleGenerator = new ScaleGenerator(settings)
        const speechEngine = new SpeechEngine()
        // viewmodel
        const i18n = new I18n()
        const noteName = new NoteName(settings, i18n)
        const scaleName = new ScaleName(i18n)
        // view
        const scaleView = new ScaleView()
        const controlsView = new ControlsView()
        const countdownTimer = new CountdownTimer()

        // connect view to model: TODO introduce proper viewmodel layer
        controlsView.onStartListener = () => {
            playAllScales().then(() => {
                scalePlayer.stop()
                controlsView.setPlayingState(false)
            })
        }
        controlsView.onStopListener = () => {
            scalePlayer.stop()
            countdownTimer.reset()
        }
        controlsView.onPrevListener = () => onMoveToScale(scaleIndex - 1)
        controlsView.onNextListener = () => onMoveToScale(scaleIndex + 1)
        function onMoveToScale(newIndex) {
            scaleIndex = newIndex
            if (scaleIndex >= scales.length) scaleIndex = 0
            if (scaleIndex < 0) scaleIndex = scales.length - 1
            countdownTimer.reset()
            scaleView.displayScale(scales[scaleIndex])
            if (scalePlayer.isPlaying()) {
                scalePlayer.stop()
                playAllScales().then(() => scalePlayer.stop())
            }

        }

        async function playAllScales() {
            const isAutoPlayEnabled = settings.isAutoPlayEnabled()
            if (isAutoPlayEnabled) {
                for (; scaleIndex < scales.length; scaleIndex++) {
                    await playScale(scales[scaleIndex])
                }
            } else {
                await playScale(scales[scaleIndex])
            }
        }
        function playScale(scale) {
            scaleView.displayScale(scale)
            const tempoBpm = settings.getTempoBpm()
            const preparationTimeS = settings.getPreparationTimeS()
            const currentlyPlayingTextTts = `${noteName.getTtsNoteName(scale.startingNote)} ${scaleName.getScaleName(scale)}`
            speechEngine.playText(currentlyPlayingTextTts)
            countdownTimer.start(settings.getPreparationTimeS())
            return scalePlayer.playScale(scale, preparationTimeS, tempoBpm)
        }

        // global state: TODO move to a model
        const scales = scaleGenerator.createScales(Note.Notes.C4)
        var scaleIndex = 0

        function app_init() {
            scaleView.displayScale(scales[0])
            i18n.translateElement(document.documentElement)
            controlsView.initViews()
            countdownTimer.initViews()
        }
    </script>
</head>

<body onload="app_init()">
    <div id="scale-id"></div>
    <div><img id="scale-img"></div>
    <div>
        <button id="button-prev" string-key="button_title_prev"></button>
        <button id="button-start-stop" string-key="button_title_start"></button>
        <button id="button-next" string-key="button_title_next"></button>
    </div>
    <div id="countdown-timer"></div>
</body>

</html>