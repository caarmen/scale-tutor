<html>

<head>
    <!-- Third party dependencies -->
    <link rel="stylesheet" href="libs/material-components-web-10.0.0.min.css">
    <link rel="stylesheet" href="libs/material-icons.css">
    <script src="libs/material-components-web-10.0.0.min.js"></script>

    <!-- Our own resources-->
    <link rel="stylesheet" href="src/css/theme.css">
    <script src="src/js/Note.js"></script>
    <script src="src/js/Scale.js"></script>
    <script>
        frequency = (initalFrequency, halfSteps) => initalFrequency * (1.059463) ** (halfSteps)

        function playScale(initialNote, scale, noteDuration) {
            return new Promise((completionFunction) => {
                const oscillator = context.createOscillator();
                // oscillator.type = "sine";
                scale.forEach((halfStep, index) => {
                    oscillator.frequency.setValueAtTime(
                        frequency(initialNote.frequency(), halfStep),
                        context.currentTime + index * noteDuration);
                })
                oscillator.connect(context.destination);
                oscillator.start(context.currentTime);
                oscillator.stop(context.currentTime + scale.length * noteDuration)
                oscillator.onended = () => { completionFunction() }
            })
        }

        async function playAllScales(startingNote) {
            for (const scale of [
                Scale.MAJOR,
                Scale.NATURAL_MINOR.map(note => note - 3),
                Scale.HARMONIC_MINOR.map(note => note - 3),
                Scale.MELODIC_MINOR.map(note => note - 3),
                Scale.BLUES
            ]) {
                await playScale(startingNote, scale, 0.25)
            }
        }
        var context
        function doit() {
            if (context) {
                context.close()
                context = undefined
            } else {
                context = new (window.AudioContext || window.webkitAudioContext)();
                const startingNote = Note.Notes[document.querySelector("#notes").value]
                playAllScales(startingNote).then(() => {
                    context.close()
                    context.onended = undefined
                    context = undefined
                })
            }
        }
    </script>
</head>

<body>
    <select name="notes" id="notes">
        <option value="C4">C4</option>
        <option value="CS4">C#4</option>
        <option value="D4">D</option>
        <option value="DS4">D#4</option>
        <option value="E4">E4</option>
        <option value="F4">F4</option>
        <option value="FS4">F#4</option>
        <option value="G4">G4</option>
        <option value="GS4">G#4</option>
        <option value="A4">A4</option>
        <option value="AS4">A#4</option>
        <option value="B4">B4</option>
        <option value="C5">C5</option>
    </select>

    <button onclick="doit()">Click me</button>
</body>

</html>