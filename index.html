<html>

<head>
    <meta charset="UTF-8">
    <!-- Third party dependencies -->
    <link rel="stylesheet" href="libs/material-components-web-10.0.0.min.css">
    <link rel="stylesheet" href="libs/material-icons.css">
    <script src="libs/material-components-web-10.0.0.min.js"></script>

    <!-- Our own resources-->
    <link rel="stylesheet" href="src/css/theme.css">
    <script src="src/js/I18n.js"></script>
    <script src="src/js/Note.js"></script>
    <script src="src/js/NoteName.js"></script>
    <script src="src/js/Scale.js"></script>
    <script src="src/js/ScaleGenerator.js"></script>
    <script src="src/js/ScaleName.js"></script>
    <script src="src/js/ScalePlayer.js"></script>
    <script src="src/js/Settings.js"></script>
    <script src="src/js/SettingsAccess.js"></script>
    <script src="src/js/strings_en.js"></script>
    <script>
        async function playAllScales(startingNote) {
            const elemScaleId = document.querySelector("#scale-id")
            const scales = scaleGenerator.createScales(startingNote)
            const tempoBpm = settings.getTempoBpm()
            const preparationTimeS = settings.getPreparationTimeS()
            for (const scale of scales) {
                const currentlyPlayingText = `${noteName.getNoteName(scale.startingNote)} ${scaleName.getScaleName(scale)}`
                elemScaleId.innerText = currentlyPlayingText
                await showCountdownTimer(settings.getPreparationTimeS())
                await scalePlayer.playScale(scale, tempoBpm)
            }
        }
        showCountdownTimer = (timeoutS) =>
            new Promise(completionFunc => {
                const elemCountdownTimer = document.querySelector("#countdown-timer")
                var remainingTimeS = timeoutS
                const intervalId = setInterval(() => {
                    remainingTimeS--
                    elemCountdownTimer.innerText = remainingTimeS
                    if (remainingTimeS == 0) {
                        clearInterval(intervalId)
                        completionFunc()
                    }
                }, 1000)
            })
        const i18n = new I18n()
        const scalePlayer = new ScalePlayer()
        const settings = new Settings(new SettingsAccess())
        const scaleGenerator = new ScaleGenerator(settings)
        const noteName = new NoteName(settings, i18n)
        const scaleName = new ScaleName(i18n)
        function doit() {
            if (scalePlayer.isPlaying()) {
                scalePlayer.stop()
            } else {
                const startingNote = Note.Notes[document.querySelector("#notes").value]
                playAllScales(startingNote).then(() => scalePlayer.stop())
            }
        }
        function app_init() {
            i18n.translateElement(document.documentElement)
        }
    </script>
</head>

<body onload="app_init()">
    <select name="notes" id="notes">
        <option value="C4" string-key="C_abc"></option>
        <option value="CS4" string-key="CS_abc"></option>
        <option value="D4" string-key="D4_abc"></option>
        <option value="DS4" string-key="DS_abc"></option>
        <option value="E4" string-key="E_abc"></option>
        <option value="F4" string-key="F_abc"></option>
        <option value="FS4" string-key="FS_abc"></option>
        <option value="G4" string-key="G_abc"></option>
        <option value="GS4" string-key="GS_abc"></option>
        <option value="A4" string-key="A_abc"></option>
        <option value="AS4" string-key="AS_abc"></option>
        <option value="B4" string-key="B_abc"></option>
        <option value="C5" string-key="C_abc"></option>
    </select>

    <div id="countdown-timer"></div>
    Currently playing: <div id="scale-id"></div>

    <button onclick="doit()">Click me</button>
</body>

</html>