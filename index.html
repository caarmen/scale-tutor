<html>

<head>
    <meta charset="UTF-8">
    <!-- Third party dependencies -->
    <link rel="stylesheet" href="libs/material-components-web-10.0.0.min.css">
    <link rel="stylesheet" href="libs/material-icons.css">
    <script src="libs/material-components-web-10.0.0.min.js"></script>

    <!-- Our own resources-->
    <link rel="stylesheet" href="src/css/theme.css">
    <script src="src/js/Note.js"></script>
    <script src="src/js/Scale.js"></script>
    <script src="src/js/i18n/I18n.js"></script>
    <script src="src/js/i18n/strings_en.js"></script>
    <script src="src/js/model/ScaleGenerator.js"></script>
    <script src="src/js/model/ScalePlayer.js"></script>
    <script src="src/js/model/Settings.js"></script>
    <script src="src/js/model/SettingsAccess.js"></script>
    <script src="src/js/model/SpeechEngine.js"></script>
    <script src="src/js/view/CountdownTimer.js"></script>
    <script src="src/js/viewmodel/NoteName.js"></script>
    <script src="src/js/viewmodel/ScaleName.js"></script>
    <script>
        async function playAllScales() {
            const tempoBpm = settings.getTempoBpm()
            const preparationTimeS = settings.getPreparationTimeS()
            const countdownTimer = new CountdownTimer(document.querySelector("#countdown-timer"))
            for (0; scaleIndex < scales.length; scaleIndex++) {
                const scale = scales[scaleIndex]
                displayScale(scale)
                const currentlyPlayingTextTts = `${noteName.getTtsNoteName(scale.startingNote)} ${scaleName.getScaleName(scale)}`
                speechEngine.playText(currentlyPlayingTextTts)
                countdownTimer.start(settings.getPreparationTimeS())
                await scalePlayer.playScale(scale, preparationTimeS, tempoBpm)
            }
        }
        const i18n = new I18n()
        const scalePlayer = new ScalePlayer()
        const settings = new Settings(new SettingsAccess())
        const scaleGenerator = new ScaleGenerator(settings)
        const noteName = new NoteName(settings, i18n)
        const scaleName = new ScaleName(i18n)
        const speechEngine = new SpeechEngine()
        var scales = []
        var scaleIndex = 0
        function generateScales(startingNote) {
            scales = scaleGenerator.createScales(startingNote)
            scaleIndex = 0;
        }
        function displayScale(scale) {
            const elemScaleId = document.querySelector("#scale-id")
            const elemScaleImg = document.querySelector("#scale-img")
            const currentlyPlayingText = `${noteName.getNoteName(scale.startingNote)} ${scaleName.getScaleName(scale)}`
            const scaleImgName = scaleName.getScaleImage(scale)
            elemScaleId.innerText = currentlyPlayingText
            elemScaleImg.src = scaleImgName
        }
        function next() {
            scaleIndex++;
            if (scaleIndex >= scales.length) scaleIndex = 0
            displayScale(scales[scaleIndex])
            if (scalePlayer.isPlaying()) {
                scalePlayer.stop()
                playAllScales().then(() => scalePlayer.stop())
            }
        }
        function start() {
            const elemButtonStartStop = document.querySelector("#button-start-stop")
            const elemButtonNext = document.querySelector("#button-next")
            if (scalePlayer.isPlaying()) {
                scalePlayer.stop()
                elemButtonStartStop.innerText = i18n.translate("button_title_start")
            } else {
                elemButtonStartStop.innerText = i18n.translate("button_title_stop")
                playAllScales().then(() => scalePlayer.stop())
            }
        }
        function app_init() {
            generateScales(Note.Notes.C4)
            displayScale(scales[0])
            i18n.translateElement(document.documentElement)
        }
    </script>
</head>

<body onload="app_init()">
    <div id="scale-id"></div>
    <div>
        <img id="scale-img">
    </div>
    <div>
        <button id="button-start-stop" string-key="button_title_start" onclick="start()"></button>
        <button id="button-next" string-key="button_title_next" onclick="next()"></button>
    </div>
    <div id="countdown-timer"></div>
</body>

</html>